<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mini Planilha Detalhes</title>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #0a0a0f;
    width: 100%;
    color: #e5e7eb;
    padding: 10px;
    font-size: 12px;
  }

  button {
    cursor: pointer;
    border: none;
    border-radius: 5px;
    font-size: 11px;
    padding: 3px 6px;
    font-weight: bold;
    margin: 2px 0;
    transition: 0.2s;
  }
  button:hover { transform: scale(1.05); }

  #voltar { background:#ef4444; color:white; margin-bottom:5px; }

  h2 { font-size:14px; margin-bottom:5px; }
  h3 { font-size:13px; margin-bottom:5px; }

  #infoRegistro {
    background: linear-gradient(135deg, #1f1f2e, #2b2b44);
    padding: 8px;
    border-radius: 10px;
    box-shadow: 0 0 8px rgba(37,99,235,0.5);
    font-size: 11px;
    margin-bottom: 8px;
  }

  #planilhaContainer {
  background: linear-gradient(135deg, #111122, #1a1a33); /* fundo escuro com gradiente */
  border-radius: 12px; /* cantos arredondados */
  padding: 5px;
  box-shadow: 0 0 10px rgba(37,99,235,0.5);
  max-height: 200px; /* altura fixa */
  overflow-y: auto;   /* rolagem se ultrapassar altura */
  border: 1px solid #3b82f6;
}

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 11px;
    color: #fff;
  }

  th {
    background: linear-gradient(90deg, #2563eb, #3b82f6);
    color: white;
    padding: 4px;
    text-align: center;
    border-bottom: 2px solid #0a0a0f;
  }

  td {
    padding: 3px;
    text-align: center;
    border-bottom: 1px solid #2b2b4d;
  }

  input[type="number"], input[type="date"] {
    width: 100%;
    padding: 2px;
    border-radius: 4px;
    border: 1px solid #2563eb;
    text-align: center;
    background: #1b1b33;
    color: #00ffff;
    font-size: 11px;
    box-shadow: inset 0 0 3px #2563eb;
  }

  #addLinha { background: #10b981; color:white; margin-top:3px; }
  #salvarPlanilha { background: #f59e0b; color:white; margin-top:3px; }
  .total-lucro {
    display: inline-block;
    background: #3b82f6;
    color: #0a0a0f;
    font-weight: bold;
    padding: 1px 5px;
    border-radius: 6px;
    font-size: 11px;
    margin-left:3px;
    box-shadow: 0 0 6px #3b82f6;
  }
</style>
</head>
<body>

<button id="voltar" onclick="window.location.href='/painel'">‚¨Ö Voltar</button>

<h2>üìã Detalhes do Registro</h2>
<div id="infoRegistro"></div>

<h3>üìä Planilha Mini</h3>
<div id="planilhaContainer">
  <table>
    <thead>
      <tr>
        <th>Data</th>
        <th>Dep√≥sito</th>
        <th>Saque</th>
        <th>Lucro</th>
      </tr>
    </thead>
    <tbody id="planilhaBody"></tbody>
  </table>
  <button id="addLinha" onclick="adicionarLinha()">‚ûï Adicionar Linha</button>
  <span>Total Lucro: <span id="lucroTotal" class="total-lucro">0</span></span>
  <br>
  <button id="salvarPlanilha" onclick="salvarPlanilha()">üíæ Salvar Planilha</button>
</div>

<script>
let registro = null;

function normalizeNumero(num){ return num.replace("@c.us","").trim(); }

window.addEventListener("DOMContentLoaded", () => {
  const id = localStorage.getItem("registroDetalheId");
  if (!id) { alert("Registro n√£o encontrado"); return; }

  fetch("/registros")
    .then(r => r.json())
    .then(data => {
      registro = data.find(r => r.id == id);
      if (!registro) { alert("Registro n√£o encontrado"); return; }

      document.getElementById("infoRegistro").innerHTML = `
        <b>Nome:</b> ${registro.nome}<br>
        <b>N√∫mero:</b> ${registro.numero}<br>
        <b>Status:</b> ${registro.status}<br>
        <b>Formul√°rio:</b> <pre>${registro.formulario}</pre>
      `;

      registro.planilha = registro.planilha || [];
      renderizarPlanilha();
    })
    .catch(console.error);
});

function renderizarPlanilha(){
  const tbody = document.getElementById("planilhaBody");
  tbody.innerHTML = "";

  registro.planilha.forEach((linha, idx) => {
    const lucro = (linha.saque || 0) - (linha.deposito || 0);
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><input type="date" value="${linha.data || ''}" onchange="atualizarLinha(${idx}, 'data', this.value)"></td>
      <td><input type="number" value="${linha.deposito || 0}" onchange="atualizarLinha(${idx}, 'deposito', parseFloat(this.value) || 0)"></td>
      <td><input type="number" value="${linha.saque || 0}" onchange="atualizarLinha(${idx}, 'saque', parseFloat(this.value) || 0)"></td>
      <td>${lucro.toFixed(2)}</td>
    `;
    tbody.appendChild(tr);
  });

  atualizarLucroTotal();
}

function atualizarLinha(idx, campo, valor){
  registro.planilha[idx][campo] = valor;
  renderizarPlanilha();
}

function adicionarLinha(){
  registro.planilha.push({data:new Date().toISOString().split('T')[0], deposito:0, saque:0});
  renderizarPlanilha();
}

function atualizarLucroTotal(){
  const total = registro.planilha.reduce((sum, l) => sum + ((l.saque || 0) - (l.deposito || 0)), 0);
  document.getElementById("lucroTotal").innerText = total.toFixed(2);
}

function salvarPlanilha() {
  if (!registro) return alert("‚ùå Registro n√£o carregado");

  // Envia para o backend
  fetch("/salvar-planilha", {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      id: registro.id,
      planilha: registro.planilha
    })
  })
  .then(r => r.json())
  .then(d => {
    if(d.ok){
      alert("‚úÖ Planilha salva com sucesso no painel!");
    } else {
      alert("‚ùå Erro ao salvar planilha");
    }
  })
  .catch(err => {
    console.error(err);
    alert("‚ùå Falha na conex√£o ao salvar planilha");
  });
}
</script>

</body>
</html>
