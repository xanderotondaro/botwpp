<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Painel Administrativo</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  margin:0;
  font-family: 'Segoe UI', Tahoma, sans-serif;
  background:#05080f;
  color:#e5e7eb;
}

header {
  background:linear-gradient(90deg,#0f172a,#020617);
  padding:18px 25px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  box-shadow:0 10px 25px rgba(0,0,0,.7);
  border-bottom:1px solid rgba(250,204,21,.25);
}

header h1 { color:#facc15; }

button {
  background:linear-gradient(145deg,#0b1220,#020617);
  color:white;
  border:1px solid rgba(250,204,21,.25);
  border-radius:10px;
  padding:8px 14px;
  cursor:pointer;
  font-weight:600;
}
button:hover { box-shadow:0 0 15px rgba(250,204,21,.4); }

.container { padding:25px; max-width:1100px; margin:auto; }

.card {
  background:linear-gradient(160deg,#0b1220,#020617);
  border-radius:16px;
  padding:20px;
  box-shadow:0 10px 25px rgba(0,0,0,.7);
  margin-bottom:25px;
}

table {
  width:100%;
  border-collapse:collapse;
  margin-top:15px;
}

th, td {
  padding:10px;
  border-bottom:1px solid rgba(255,255,255,.08);
  text-align:left;
}

th { color:#facc15; }

input, select {
  background:#020617;
  color:white;
  border:1px solid rgba(250,204,21,.25);
  border-radius:8px;
  padding:8px;
  width:100%;
}

.actions button { margin-right:6px; }
.delete { background:#7f1d1d; }
.save { background:#14532d; }
</style>
</head>

<body>

<header>
  <h1>‚öôÔ∏è Painel Administrativo</h1>
  <div>
    <button onclick="location.href='/painel'">üìä Painel</button>
    <button onclick="logout()" style="background:#7f1d1d;">Sair</button>
  </div>
</header>

<div class="container">

<div class="card">
<h2>‚ûï Criar Usu√°rio</h2>
<br>
<input id="novoUsuario" placeholder="Usu√°rio">
<br><br>
<input id="novaSenha" placeholder="Senha" type="password">
<br><br>
<select id="novoNivel" onchange="mostrarToken()">
  <option value="cpa">CPA</option>
  <option value="admin">ADMIN</option>
</select>
<br><br>
<input id="superAdminToken" placeholder="Token do Super Admin" style="display:none;" autocomplete="off">
<br><br>
<button onclick="criarUsuario()">Criar Usu√°rio</button>
</div>

<div class="card">
<h2>üë• Usu√°rios</h2>
<table>
<thead>
<tr>
  <th>Usu√°rio</th>
  <th>N√≠vel</th>
  <th>CPA</th>
  <th>A√ß√µes</th>
</tr>
</thead>
<tbody id="listaUsuarios"></tbody>
</table>
</div>

</div>

<script>
async function carregarUsuarios(){
  const res = await fetch("/admin/usuarios");
  const data = await res.json();

  const tbody = document.getElementById("listaUsuarios");
  tbody.innerHTML="";

  data.forEach(u=>{
    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td>${u.usuario}</td>
      <td>${u.nivel}</td>
      <td>
        ${u.nivel === "cpa"
          ? `<input value="${u.cpa||""}" onchange="editarCPA(${u.id},this.value)">`
          : "‚Äî"}
      </td>
      <td class="actions">
        <button class="delete" onclick="apagarUsuario(${u.id})">üóë</button>
      </td>
    `;

    tbody.appendChild(tr);
  });
}

function mostrarToken() {
  const nivel = document.getElementById('novoNivel').value;
  document.getElementById('superAdminToken').style.display = nivel === 'admin' ? '' : 'none';
}

async function criarUsuario(){
  const usuario = novoUsuario.value.trim();
  const senha = novaSenha.value.trim();
  const nivel = novoNivel.value;
  const superAdminToken = document.getElementById('superAdminToken').value.trim();

  if(!usuario || !senha) return alert("Preencha tudo");
  if(nivel === 'admin' && !superAdminToken) return alert("Informe o token do super admin");

  const res = await fetch("/admin/criar-usuario",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({ usuario, senha, nivel, superAdminToken })
  });

  const data = await res.json();
  if(!data.ok) return alert(data.msg || "Erro ao criar");

  novoUsuario.value="";
  novaSenha.value="";
  superAdminToken.value="";
  carregarUsuarios();
}

async function editarCPA(id,cpa){
  await fetch("/admin/editar-cpa",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({ id, cpa })
  });
}

async function apagarUsuario(id){
  if(!confirm("Deseja apagar este usu√°rio?")) return;

  const res = await fetch("/admin/apagar-usuario",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({ id })
  });

  const data = await res.json();
  if(data.ok) carregarUsuarios();
  else alert("Erro ao apagar");
}

function logout(){
  fetch("/logout").then(()=> location.href="/login.html");
}

carregarUsuarios();
</script>
</body>
</html>
